# AgentTree Project Rules

## ⛔ NEVER USE RAW TMUX OR CONTAINER COMMANDS

**ALWAYS use `agenttree` CLI commands. NEVER use raw tmux or container commands unless the CLI literally cannot do what you need.**

| ❌ NEVER DO THIS | ✅ ALWAYS DO THIS |
|------------------|-------------------|
| `tmux list-sessions` | `agenttree status` |
| `tmux capture-pane` | `agenttree output <id>` |
| `tmux send-keys` | `agenttree send <id> "msg"` |
| `tmux kill-session` | `agenttree stop <id>` |
| `container run ...` | `agenttree start <id>` |
| `container exec ...` | `agenttree attach <id>` |
| `container list` | `agenttree status` |
| `container stop` | `agenttree stop <id>` |

Raw tmux/container commands bypass workflow, break state tracking, and cause bugs. The CLI handles everything properly.

**If you find yourself typing `tmux` or `container`, STOP and find the agenttree command instead.**

## Documentation Structure

**All documentation goes in `agents/` repository, NOT in the main codebase.**

When creating plans, specs, proposals, or documentation:
- `agents/plans/` - Planning docs, proposals, design discussions
- `agents/specs/` - Feature specifications, architecture docs
- `agents/rfcs/` - Request for comments, major decisions
- `agents/knowledge/` - Gotchas, patterns, onboarding info
- `agents/tasks/` - Task logs and work history

**DO NOT create:**
- `docs/` directories in main repo
- README files for documentation (only for project overview)
- Proposal files outside of agents/

See `agents/AGENTS.md` for full documentation conventions.

## Container Security

AgentTree REQUIRES containers for agent execution. There is no non-container mode.
- All agents run in isolated containers
- No fallbacks, no bypasses
- See `docs/SECURITY.md` for security model

## Task System

Tasks are stored in `tasks/` directory within agent worktrees:
- Files named: `YYYY-MM-DD-task-title.md`
- Oldest task is worked on first (FIFO)
- Completed tasks move to `tasks/archive/`

## Code Style

- Python with type hints
- Pydantic for config/models
- Click for CLI
- FastAPI for web server
- Rich for terminal output

## Module Ownership — One Function, One Place

Every operation has ONE authoritative function. Don't reinvent, don't call lower-level primitives.

| Operation | Authoritative function | Module |
|-----------|----------------------|--------|
| Stop an agent | `stop_agent()` | `agenttree/api.py` |
| Stop all agents for issue | `stop_all_agents_for_issue()` | `agenttree/api.py` |
| Start an agent | `start_agent()` | `agenttree/api.py` |
| Send message to agent | `send_message()` | `agenttree/api.py` |
| Transition issue stage | `transition_issue()` | `agenttree/api.py` |
| Clean up orphaned containers | `cleanup_orphaned_containers()` | `agenttree/api.py` |
| Notify agent (best-effort) | `_notify_agent()` | `agenttree/api.py` |

**Never call `kill_session()` directly to stop an agent — use `stop_agent()`.**
**Never manually do exit_hooks + update_stage + enter_hooks — use `transition_issue()`.**

## No Silent Failures

- `ensure_pr_for_issue()` raises `RuntimeError` on failure, not `return False`
- `_action_merge_pr()` raises `RuntimeError` if no PR number, not silent return
- `check_manager_stages()` logs warnings on exceptions, not bare `continue`
- Manager heartbeat notifies agents on StageRedirect (via `_notify_agent()`)
