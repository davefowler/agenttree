# AgentTree Configuration
# This file is the source of truth for all workflow configuration.
# See https://github.com/davefowler/agenttree for documentation.

default_tool: claude
default_model: opus
port_range: 9001-9099
project: "{{PROJECT_NAME}}"
worktrees_dir: .worktrees

# Commands are optional. Define project-specific commands here.
# These can be referenced in hooks using {{commands.test}}, etc.
commands:
  # test: npm test                    # Example: Node.js
  # test: pytest                      # Example: Python
  # lint: eslint .                    # Example: JavaScript
  # serve: npm run dev --port $PORT   # Dev server (port auto-assigned per issue)
  git_branch: git branch --show-current
  files_changed: "git diff --stat main...HEAD | grep -c '|' || echo 0"
  lines_added: "git diff --stat main...HEAD | tail -1 | awk '{print $4}' || echo 0"
  lines_removed: "git diff --stat main...HEAD | tail -1 | awk '{print $6}' || echo 0"

tools:
  claude:
    command: claude
    skip_permissions: true
    startup_prompt: "Read TASK.md - it has your issue ID, stage, and workflow instructions. Follow the staged workflow."
  aider:
    command: aider
    startup_prompt: /read TASK.md
  codex:
    command: codex
    startup_prompt: "Read TASK.md for your instructions."

# Host configurations
# Hosts are execution environments that handle stages in the workflow.
# Each host can specify container settings, AI tool, model, and skills.
hosts:
  # Controller: Human-driven, runs on host machine (no container)
  # Runs the sync server which spawns agents and runs hooks
  controller:
    description: "Human-driven controller"
    process: "agenttree serve"  # Runs in tmux, handles syncs

  # Default AI agent: runs in container
  agent:
    description: "Default AI agent"
    container:
      image: "{{PROJECT_NAME}}-agent:latest"  # Build your container image with this name
    tool: claude
    model: opus

# Workflow stages
# Customize the stages below based on your workflow needs.
stages:
  - name: backlog
    is_parking_lot: true

  - name: define
    output: problem.md
    pre_completion:
      - title_set:  # Ensure issue has a real title, not "(untitled)"
      - section_check:
          file: problem.md
          section: Context
          expect: not_empty
      - has_list_items:
          file: problem.md
          section: Possible Solutions
    substages:
      refine: {}

  - name: research
    output: research.md
    post_start:
      - create_file:
          template: research.md
          dest: research.md
    pre_completion:
      - section_check:
          file: research.md
          section: Relevant Files
          expect: not_empty
      - section_check:
          file: research.md
          section: Existing Patterns
          expect: not_empty
    substages:
      explore: {}
      document: {}

  - name: plan
    output: spec.md
    post_start:
      - create_file:
          template: spec.md
          dest: spec.md
    pre_completion:
      - section_check:
          file: spec.md
          section: Approach
          expect: not_empty
      - has_list_items:
          file: spec.md
          section: Files to Modify
      - has_list_items:
          file: spec.md
          section: Implementation Steps
      - section_check:
          file: spec.md
          section: Test Plan
          expect: not_empty
    substages:
      draft: {}
      refine: {}

  - name: plan_assess
    output: spec_review.md
    post_start:
      - create_file:
          template: spec_review.md
          dest: spec_review.md
    pre_completion:
      - section_check:
          file: spec_review.md
          section: Assessment Summary
          expect: not_empty

  - name: plan_revise
    output: spec.md

  - name: plan_review
    human_review: true
    review_doc: spec.md
    pre_completion:
      - file_exists: spec.md
      - section_check:
          file: spec.md
          section: Approach
          expect: not_empty
      - rebase:

  - name: implement
    substages:
      setup: {}
      code: {}
      debug:
        skill: implement-debug.md
      code_review:
        output: review.md
        post_start:
          - create_file:
              template: review.md
              dest: review.md
        pre_completion:
          # Add your test/lint commands here. Example:
          # - run:
          #     command: npm test
          #     must_pass: true
          - section_check:
              file: review.md
              section: Self-Review Checklist
              expect: all_checked
      address_review: {}
      wrapup:
        pre_completion:
          - wrapup_verified: review.md
      feedback:
        output: feedback.md
        pre_completion:
          - has_commits:
          - file_exists: review.md
          - section_check:
              file: review.md
              section: Critical Issues
              expect: empty

  # ADVANCED FEATURE: independent_code_review stages (not in default template)
  # ----------------------------------------------------------------------------------
  # The independent_code_review and address_independent_review stages provide AI-driven
  # code review before human review. These are intentionally excluded from the default
  # template because:
  #   1. They require a custom "review" host with specific container/model configuration
  #   2. They add complexity that most projects don't need initially
  #   3. This default template is designed to work out-of-the-box for any project
  #
  # To enable AI-driven code review, add the following to your .agenttree.yaml:
  #   - A "review" host configuration under the hosts section
  #   - The independent_code_review and address_independent_review stages
  #   - Update the default flow to include these stages
  #
  # See agenttree documentation for advanced stage configuration examples.

  - name: implementation_review
    human_review: true
    review_doc: review.md
    host: controller  # Host handles PR creation (agents can't push)
    post_start:
      - create_pr:
    substages:
      ci_wait:
        pre_completion:
          - ci_check:
              timeout: 600
              poll_interval: 30
            host_only: true
      review: {}
    pre_completion:
      - pr_approved:

  - name: knowledge_base
    host: agent
    skill: knowledge_base.md

  - name: accepted
    is_parking_lot: true
    host: controller  # Host handles merge/cleanup (agents can't push)
    post_start:
      - merge_pr:
      - cleanup_agent:
      - start_blocked_issues:

  - name: not_doing
    is_parking_lot: true
    redirect_only: true  # Only reached via redirect, not normal progression

# Workflow flows
# Each flow defines an ordered subset of stages that issues can follow.
# The "default" flow is used if no flow is specified when creating an issue.
# Parking lot stages like not_doing are redirect targets, not part of normal progression.
flows:
  default:
    stages:
      - backlog
      - define
      - research
      - plan
      - plan_assess
      - plan_revise
      - plan_review
      - implement
      - implementation_review
      - knowledge_base
      - accepted

  # Quick flow for small issues that skip research and planning stages
  quick:
    stages:
      - backlog
      - define
      - implement
      - implementation_review
      - accepted

  # Abandoned issues - only reachable via redirect
  not_doing:
    stages:
      - not_doing

default_flow: default

# Controller hooks for dogfooding - track cleanup frequency to identify workflow issues
# This is project-specific logging to help us find broken workflow steps
controller_hooks:
  post_sync:
    # Run periodic cleanup and log what was cleaned
    # High cleanup frequency indicates broken workflow steps that need fixing
    - cleanup_resources:
        log_file: _agenttree/logs/cleanup.log
