# AgentTree Configuration
# This file is the source of truth for all workflow configuration.
# See https://github.com/davefowler/agenttree for documentation.

default_tool: claude
default_model: opus
port_range: 9001-9099
project: "agenttree"
worktrees_dir: .worktrees

test_commands:
  - echo "No test command configured - update test_commands in .agenttree.yaml"

lint_commands:
  - echo "No lint command configured - update lint_commands in .agenttree.yaml"

tools:
  claude:
    command: claude
    startup_prompt: "Read TASK.md - it has your issue ID, stage, and workflow instructions. You MUST follow the staged workflow."
  aider:
    command: aider
    startup_prompt: /read TASK.md

stages:
  - name: backlog

  - name: define
    output: problem.md
    pre_completion:
      - section_check:
          file: problem.md
          section: Context
          expect: not_empty
      - has_list_items:
          file: problem.md
          section: Possible Solutions
    substages:
      refine: {}

  - name: research
    output: research.md
    post_start:
      - create_file:
          template: research.md
          dest: research.md
    pre_completion:
      - section_check:
          file: research.md
          section: Relevant Files
          expect: not_empty
      - section_check:
          file: research.md
          section: Existing Patterns
          expect: not_empty
    substages:
      explore: {}
      document: {}

  - name: plan
    output: spec.md
    post_start:
      - create_file:
          template: spec.md
          dest: spec.md
    pre_completion:
      - section_check:
          file: spec.md
          section: Approach
          expect: not_empty
      - has_list_items:
          file: spec.md
          section: Files to Modify
      - has_list_items:
          file: spec.md
          section: Implementation Steps
      - section_check:
          file: spec.md
          section: Test Plan
          expect: not_empty
    substages:
      draft: {}
      refine: {}

  - name: plan_assess
    output: spec_review.md
    post_start:
      - create_file:
          template: spec_review.md
          dest: spec_review.md
    pre_completion:
      - section_check:
          file: spec_review.md
          section: Assessment Summary
          expect: not_empty

  - name: plan_revise
    output: spec.md

  - name: plan_review
    human_review: true
    pre_completion:
      - file_exists: spec.md
      - section_check:
          file: spec.md
          section: Approach
          expect: not_empty
      - rebase:

  - name: implement
    pre_completion:
      - run: agenttree lint
        optional: true
        context: Lint
      - run: agenttree test
        optional: true
        context: Tests
    substages:
      setup: {}
      code: {}
      code_review:
        output: review.md
        post_start:
          - create_file:
              template: review.md
              dest: review.md
        pre_completion:
          - section_check:
              file: review.md
              section: Self-Review Checklist
              expect: all_checked
      address_review: {}
      wrapup:
        pre_completion:
          - file_exists: review.md
          - field_check:
              file: review.md
              path: average
              min: 7
      feedback:
        output: feedback.md
        pre_completion:
          - has_commits:
          - file_exists: review.md
          - section_check:
              file: review.md
              section: Critical Issues
              expect: empty

  - name: implementation_review
    human_review: true
    host: controller  # Host handles PR creation (agents can't push)
    post_start:
      - create_pr:
    pre_completion:
      - pr_approved:

  - name: accepted
    terminal: true
    host: controller  # Host handles merge/cleanup (agents can't push)
    post_start:
      - merge_pr:
      - cleanup_agent:
      - start_blocked_issues:

  - name: not_doing
    terminal: true
