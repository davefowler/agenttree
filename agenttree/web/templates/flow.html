<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow - AgentTree</title>
    <link rel="stylesheet" href="/static/styles.css?v=8">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- diff2html for code diff rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/diff2html@3.4.48/bundles/css/diff2html.min.css">
    <script src="https://cdn.jsdelivr.net/npm/diff2html@3.4.48/bundles/js/diff2html-ui.min.js"></script>
</head>
<body>
    {% include 'partials/header.html' %}

    <div class="flow-container">
        <!-- Left sidebar: Issue list (no polling - refresh page for updates) -->
        <div class="flow-sidebar">
            {% if issues %}
                {% for issue in issues %}
                {% set base_url = '/flow' %}
                {% set show_stage = true %}
                {% include 'partials/issue_item.html' %}
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <p>No open issues</p>
                </div>
            {% endif %}
        </div>

        <!-- Main panel: Issue detail with file tabs -->
        <div class="flow-main" id="issue-detail">
            {% if selected_issue %}
                {% set issue = selected_issue %}
                {% include 'partials/issue_detail_content.html' %}
            {% else %}
                <div class="empty-state">
                    <h2>No issues found</h2>
                    <p>All caught up!</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Controller panel -->
    {% include 'partials/controller_panel.html' %}

    <script>
        // Handle file tab clicks - CSS toggle approach
        function selectFileTab(evt, issueId, filename) {
            const tabContainer = evt.target.closest('.file-tabs');
            tabContainer.querySelectorAll('.file-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            evt.target.classList.add('active');

            // Show/hide content areas
            const contentContainer = document.getElementById('file-content-' + issueId);
            contentContainer.querySelectorAll('.file-content-item').forEach(item => {
                item.style.display = item.dataset.filename === filename ? 'block' : 'none';
            });
        }

        // Toggle agent chat panel
        function toggleChatPanel(issueNumber) {
            const panel = document.getElementById('agent-chat-panel-' + issueNumber);
            if (panel) {
                panel.classList.toggle('collapsed');
            }
        }

        // Agent light toggle (for sidebar)
        window.toggleAgent = async function(issueNumber, lightElement) {
            const isOn = lightElement.classList.contains('on');

            if (isOn) {
                // Agent is running - stop it
                lightElement.classList.remove('on');
                lightElement.classList.add('stopping');
                lightElement.title = 'Stopping agent...';

                try {
                    const response = await fetch(`/api/issues/${issueNumber}/stop`, {
                        method: 'POST'
                    });

                    if (response.ok) {
                        lightElement.classList.remove('stopping');
                        lightElement.classList.add('off');
                        lightElement.title = 'No agent - click to start';
                        setTimeout(() => location.reload(), 500);
                    } else {
                        lightElement.classList.remove('stopping');
                        lightElement.classList.add('on');
                        lightElement.title = 'Failed to stop agent';
                    }
                } catch (error) {
                    console.error('Error stopping agent:', error);
                    lightElement.classList.remove('stopping');
                    lightElement.classList.add('on');
                    lightElement.title = 'Error stopping agent';
                }
                return;
            }

            // Start/restart the agent
            lightElement.classList.remove('off', 'stalled');
            lightElement.classList.add('starting');
            lightElement.title = 'Starting agent...';

            try {
                const response = await fetch(`/api/issues/${issueNumber}/start`, {
                    method: 'POST'
                });

                if (response.ok) {
                    setTimeout(() => location.reload(), 2000);
                } else {
                    lightElement.classList.remove('starting');
                    lightElement.classList.add('stalled');
                    lightElement.title = 'Failed to start - click to retry';
                }
            } catch (error) {
                console.error('Error starting agent:', error);
                lightElement.classList.remove('starting');
                lightElement.classList.add('stalled');
                lightElement.title = 'Error - click to retry';
            }
        };

        // Go to next issue in the flow sidebar
        window.goToNextIssue = function() {
            const items = document.querySelectorAll('.issue-item');
            const activeItem = document.querySelector('.issue-item.active');

            if (items.length === 0) {
                location.reload();
                return;
            }

            let nextItem = null;
            if (activeItem) {
                const activeIndex = Array.from(items).indexOf(activeItem);
                // Get next item, or first if at end
                nextItem = items[activeIndex + 1] || items[0];
            } else {
                nextItem = items[0];
            }

            if (nextItem && nextItem.href) {
                window.location.href = nextItem.href;
            } else {
                location.reload();
            }
        };

        // Cmd+L (Mac) or Ctrl+L (Windows/Linux) to send highlighted text to agent
        document.addEventListener('keydown', (e) => {
            if (e.key === 'l' && (e.metaKey || e.ctrlKey)) {
                const selectedText = window.getSelection().toString().trim();
                if (!selectedText) return; // No text selected, let browser handle

                // Find the visible agent chat input in the flow main panel
                const chatInput = document.querySelector('.flow-main .tmux-input');

                if (chatInput) {
                    e.preventDefault(); // Prevent browser default (e.g., focus address bar)

                    // Get file context from active tab
                    const activeTab = document.querySelector('.flow-main .file-tab.active');
                    const filename = activeTab?.getAttribute('data-filename');
                    const message = filename
                        ? `In ${filename}: "${selectedText}"\n`
                        : selectedText;

                    chatInput.value = message;
                    chatInput.focus();
                }
            }
        });

        // Agent light toggle (for detail view)
        async function toggleAgentFromDetail(issueNumber, lightElement) {
            const isOn = lightElement.classList.contains('on');

            if (isOn) {
                // Agent is running - stop it
                lightElement.classList.remove('on');
                lightElement.classList.add('stopping');
                lightElement.title = 'Stopping agent...';

                try {
                    const response = await fetch(`/api/issues/${issueNumber}/stop`, {
                        method: 'POST'
                    });

                    if (response.ok) {
                        lightElement.classList.remove('stopping');
                        lightElement.classList.add('off');
                        lightElement.title = 'No agent - click to start';
                        setTimeout(() => location.reload(), 500);
                    } else {
                        lightElement.classList.remove('stopping');
                        lightElement.classList.add('on');
                        lightElement.title = 'Failed to stop agent';
                    }
                } catch (error) {
                    console.error('Error stopping agent:', error);
                    lightElement.classList.remove('stopping');
                    lightElement.classList.add('on');
                    lightElement.title = 'Error stopping agent';
                }
                return;
            }

            lightElement.classList.remove('off', 'stalled');
            lightElement.classList.add('starting');
            lightElement.title = 'Starting agent...';

            try {
                const response = await fetch(`/api/issues/${issueNumber}/start`, {
                    method: 'POST'
                });

                if (response.ok) {
                    setTimeout(() => location.reload(), 2000);
                } else {
                    lightElement.classList.remove('starting');
                    lightElement.classList.add('stalled');
                    lightElement.title = 'Failed to start - click to retry';
                }
            } catch (error) {
                console.error('Error starting agent:', error);
                lightElement.classList.remove('starting');
                lightElement.classList.add('stalled');
                lightElement.title = 'Error - click to retry';
            }
        }
    </script>
</body>
</html>
