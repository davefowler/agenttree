<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow - AgentTree</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    {% include 'partials/header.html' %}

    <div class="flow-container">
        <!-- Left sidebar: Issue list (no polling - refresh page for updates) -->
        <div class="flow-sidebar">
            {% if issues %}
                {% for issue in issues %}
                <a class="issue-item {% if selected_issue and issue.number == selected_issue.number %}active{% endif %}"
                   href="/flow?issue={{ issue.number }}{% if chat_open %}&chat=1{% endif %}">
                    {% set show_stage = true %}
                    {% include 'partials/issue_item.html' %}
                </a>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <p>No open issues</p>
                </div>
            {% endif %}
        </div>

        <!-- Main panel: Issue detail with file tabs -->
        <div class="flow-main" id="issue-detail">
            {% if selected_issue %}
                {% set issue = selected_issue %}
                {% include 'partials/issue_detail_content.html' %}
            {% else %}
                <div class="empty-state">
                    <h2>No issues found</h2>
                    <p>All caught up!</p>
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        // Handle file tab clicks - CSS toggle approach
        function selectFileTab(evt, issueId, filename) {
            const tabContainer = evt.target.closest('.file-tabs');
            tabContainer.querySelectorAll('.file-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            evt.target.classList.add('active');

            // Show/hide content areas
            const contentContainer = document.getElementById('file-content-' + issueId);
            contentContainer.querySelectorAll('.file-content-item').forEach(item => {
                item.style.display = item.dataset.filename === filename ? 'block' : 'none';
            });
        }

        // Toggle agent chat panel
        function toggleChatPanel(issueNumber) {
            const panel = document.getElementById('agent-chat-panel-' + issueNumber);
            if (panel) {
                panel.classList.toggle('collapsed');
            }
        }

        // Agent light toggle (for sidebar)
        window.toggleAgent = async function(issueNumber, lightElement) {
            const isOn = lightElement.classList.contains('on');

            if (isOn) {
                // Agent is running - navigate to issue
                window.location.href = `/flow?issue=${issueNumber}`;
                return;
            }

            // Start/restart the agent
            lightElement.classList.remove('off', 'stalled');
            lightElement.classList.add('starting');
            lightElement.title = 'Starting agent...';

            try {
                const response = await fetch(`/api/issues/${issueNumber}/start`, {
                    method: 'POST'
                });

                if (response.ok) {
                    setTimeout(() => location.reload(), 2000);
                } else {
                    lightElement.classList.remove('starting');
                    lightElement.classList.add('stalled');
                    lightElement.title = 'Failed to start - click to retry';
                }
            } catch (error) {
                console.error('Error starting agent:', error);
                lightElement.classList.remove('starting');
                lightElement.classList.add('stalled');
                lightElement.title = 'Error - click to retry';
            }
        };

        // Go to next issue in the flow sidebar
        window.goToNextIssue = function() {
            const items = document.querySelectorAll('.issue-item');
            const activeItem = document.querySelector('.issue-item.active');

            if (items.length === 0) {
                location.reload();
                return;
            }

            let nextItem = null;
            if (activeItem) {
                const activeIndex = Array.from(items).indexOf(activeItem);
                // Get next item, or first if at end
                nextItem = items[activeIndex + 1] || items[0];
            } else {
                nextItem = items[0];
            }

            if (nextItem && nextItem.href) {
                window.location.href = nextItem.href;
            } else {
                location.reload();
            }
        };

        // Agent light toggle (for detail view)
        async function toggleAgentFromDetail(issueNumber, lightElement) {
            const isOn = lightElement.classList.contains('on');

            if (isOn) {
                // Already running - do nothing (use chat icon to toggle chat)
                return;
            }

            lightElement.classList.remove('off', 'stalled');
            lightElement.classList.add('starting');
            lightElement.title = 'Starting agent...';

            try {
                const response = await fetch(`/api/issues/${issueNumber}/start`, {
                    method: 'POST'
                });

                if (response.ok) {
                    setTimeout(() => location.reload(), 2000);
                } else {
                    lightElement.classList.remove('starting');
                    lightElement.classList.add('stalled');
                    lightElement.title = 'Failed to start - click to retry';
                }
            } catch (error) {
                console.error('Error starting agent:', error);
                lightElement.classList.remove('starting');
                lightElement.classList.add('stalled');
                lightElement.title = 'Error - click to retry';
            }
        }
    </script>
</body>
</html>
