<header>
    <div class="header-row">
        <h1>ðŸ¤–ðŸŒ³ AgentTree</h1>
        <nav class="tabs">
            <a href="/kanban" class="tab {{ 'active' if active_page == 'kanban' else '' }}">Kanban</a>
            <a href="/flow" class="tab {{ 'active' if active_page == 'flow' else '' }}">Flow</a>
        </nav>
        <div class="search-container">
            <input type="search"
                   id="search-input"
                   name="search"
                   class="search-input"
                   placeholder="Search issues..."
                   value="{{ search }}"
                   hx-get="/{{ active_page }}"
                   hx-trigger="input changed delay:300ms, search"
                   hx-target="body"
                   hx-swap="outerHTML"
                   hx-push-url="true"
                   hx-preserve="true"
                   hx-include=".search-preserve">
            {% if request.query_params.get('view') %}
            <input type="hidden" name="view" value="{{ request.query_params.get('view') }}" class="search-preserve">
            {% endif %}
            {% if request.query_params.get('issue') %}
            <input type="hidden" name="issue" value="{{ request.query_params.get('issue') }}" class="search-preserve">
            {% endif %}
        </div>
        {% if active_page == 'kanban' %}
        <div class="stage-toggle">
            <button class="toggle-btn active" onclick="setStageView('review')" id="toggle-review">Review Stages</button>
            <button class="toggle-btn" onclick="setStageView('nonempty')" id="toggle-nonempty">Non-Empty</button>
            <button class="toggle-btn" onclick="setStageView('all')" id="toggle-all">All Stages</button>
        </div>
        <button class="btn btn-new-issue" onclick="openNewIssueModal()">+ New Issue</button>
        {% endif %}
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark theme">
            <span class="theme-icon">ðŸŒ™</span>
        </button>
    </div>
</header>
<script>
    // Theme toggle functionality
    function toggleTheme() {
        const html = document.documentElement;
        const currentTheme = html.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);
    }

    function updateThemeIcon(theme) {
        const icon = document.querySelector('.theme-icon');
        if (icon) {
            icon.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
        }
    }

    // Apply saved theme on load
    (function() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        // Update icon after DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => updateThemeIcon(savedTheme));
        } else {
            updateThemeIcon(savedTheme);
        }
    })();

    // Auto-refresh disabled - was causing loops with HTMX morph
    // TODO: implement smarter partial refresh for issue status
</script>
