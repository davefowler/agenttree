<header>
    <div class="header-row">
        <h1>ðŸ¤–ðŸŒ³ AgentTree</h1>
        <nav class="tabs">
            <a href="/kanban" class="tab {{ 'active' if active_page == 'kanban' else '' }}">Kanban</a>
            <a href="/flow" class="tab {{ 'active' if active_page == 'flow' else '' }}">Flow</a>
        </nav>
        <div class="search-container">
            <input type="search"
                   id="search-input"
                   name="search"
                   class="search-input"
                   placeholder="Search issues..."
                   value="{{ search }}"
                   hx-get="/{{ active_page }}"
                   hx-trigger="input changed delay:300ms, search"
                   hx-target="body"
                   hx-swap="outerHTML"
                   hx-push-url="true"
                   hx-preserve="true"
                   hx-include=".search-preserve">
            {% if request.query_params.get('view') %}
            <input type="hidden" name="view" value="{{ request.query_params.get('view') }}" class="search-preserve">
            {% endif %}
            {% if request.query_params.get('issue') %}
            <input type="hidden" name="issue" value="{{ request.query_params.get('issue') }}" class="search-preserve">
            {% endif %}
        </div>
        {% if active_page == 'kanban' %}
        <div class="stage-toggle">
            <button class="toggle-btn active" onclick="setStageView('review')" id="toggle-review">Review Stages</button>
            <button class="toggle-btn" onclick="setStageView('nonempty')" id="toggle-nonempty">Non-Empty</button>
            <button class="toggle-btn" onclick="setStageView('all')" id="toggle-all">All Stages</button>
        </div>
        <button class="btn btn-new-issue" onclick="openNewIssueModal()">+ New Issue</button>
        {% elif active_page == 'flow' %}
        <div class="flow-controls">
            <label class="flow-control-label">Sort:</label>
            <select class="flow-select" onchange="updateFlowParams('sort', this.value)">
                <option value="stage" {{ 'selected' if current_sort == 'stage' else '' }}>Stage</option>
                <option value="updated" {{ 'selected' if current_sort == 'updated' else '' }}>Updated</option>
                <option value="created" {{ 'selected' if current_sort == 'created' else '' }}>Created</option>
                <option value="number" {{ 'selected' if current_sort == 'number' else '' }}>Number</option>
            </select>
            <label class="flow-control-label">Filter:</label>
            <select class="flow-select" onchange="updateFlowParams('filter', this.value)">
                <option value="all" {{ 'selected' if current_filter == 'all' else '' }}>All</option>
                <option value="review" {{ 'selected' if current_filter == 'review' else '' }}>Review</option>
                <option value="running" {{ 'selected' if current_filter == 'running' else '' }}>Running</option>
                <option value="open" {{ 'selected' if current_filter == 'open' else '' }}>Open</option>
            </select>
        </div>
        <script>
            function updateFlowParams(param, value) {
                const url = new URL(window.location);
                if (value === 'stage' && param === 'sort') {
                    url.searchParams.delete('sort');
                } else if (value === 'all' && param === 'filter') {
                    url.searchParams.delete('filter');
                } else {
                    url.searchParams.set(param, value);
                }
                window.location.href = url.toString();
            }
        </script>
        {% endif %}
        <button class="controller-toggle" onclick="toggleControllerPanel()" title="Toggle controller panel">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="15" y1="3" x2="15" y2="21"></line>
            </svg>
        </button>
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark theme">
            <span class="theme-icon">ðŸŒ™</span>
        </button>
    </div>
</header>
<script>
    // Theme toggle functionality
    function toggleTheme() {
        const html = document.documentElement;
        const currentTheme = html.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);
    }

    function updateThemeIcon(theme) {
        const icon = document.querySelector('.theme-icon');
        if (icon) {
            icon.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
        }
    }

    // Apply saved theme on load
    (function() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        // Update icon after DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => updateThemeIcon(savedTheme));
        } else {
            updateThemeIcon(savedTheme);
        }
    })();

    // Auto-refresh disabled - was causing loops with HTMX morph
    // TODO: implement smarter partial refresh for issue status
</script>
