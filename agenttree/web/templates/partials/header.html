<header>
    <div class="header-row">
        <h1>ðŸ¤–ðŸŒ³ AgentTree</h1>
        <nav class="tabs">
            <a href="/kanban" class="tab {{ 'active' if active_page == 'kanban' else '' }}">Kanban</a>
            <a href="/flow" class="tab {{ 'active' if active_page == 'flow' else '' }}">Flow</a>
        </nav>
        {% if active_page == 'kanban' %}
        <div class="stage-toggle">
            <button class="toggle-btn active" onclick="setStageView('review')" id="toggle-review">Review Stages</button>
            <button class="toggle-btn" onclick="setStageView('nonempty')" id="toggle-nonempty">Non-Empty</button>
            <button class="toggle-btn" onclick="setStageView('all')" id="toggle-all">All Stages</button>
        </div>
        {% endif %}
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark theme">
            <span class="theme-icon">ðŸŒ™</span>
        </button>
    </div>
</header>
<script>
    // Theme toggle functionality
    function toggleTheme() {
        const html = document.documentElement;
        const currentTheme = html.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);
    }

    function updateThemeIcon(theme) {
        const icon = document.querySelector('.theme-icon');
        if (icon) {
            icon.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
        }
    }

    // Apply saved theme on load
    (function() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        // Update icon after DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => updateThemeIcon(savedTheme));
        } else {
            updateThemeIcon(savedTheme);
        }
    })();

    // Auto-refresh page every 15 seconds using HTMX morph (smart DOM diffing)
    // This preserves elements that haven't changed and doesn't disrupt in-flight polls
    (function() {
        let refreshInterval = 15000; // 15 seconds

        setInterval(() => {
            // Don't refresh if user is typing in an input/textarea
            const activeEl = document.activeElement;
            if (activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA')) {
                return;
            }
            // Use HTMX to fetch and morph the page
            htmx.ajax('GET', window.location.href, {
                target: 'body',
                swap: 'morph:innerHTML'
            });
        }, refreshInterval);
    })();
</script>
