<header>
    <div class="header-row">
        <h1>AgentTree</h1>
        <nav class="tabs">
            <a href="/kanban" class="tab {{ 'active' if active_page == 'kanban' else '' }}">Kanban</a>
            <a href="/flow" class="tab {{ 'active' if active_page == 'flow' else '' }}">Flow</a>
            <a href="/mobile" class="tab {{ 'active' if active_page == 'mobile' else '' }}">Mobile</a>
        </nav>
        {% if active_page == 'kanban' %}
        <select class="header-select" onchange="setStageView(this.value)" id="stage-view-select">
            <option value="review" {{ 'selected' if current_view == 'review' else '' }}>Review Stages</option>
            <option value="nonempty" {{ 'selected' if current_view == 'nonempty' else '' }}>Non-Empty</option>
            <option value="all" {{ 'selected' if current_view == 'all' else '' }}>All Stages</option>
        </select>
        {% elif active_page == 'flow' %}
        <select class="header-select" onchange="updateFlowParams('sort', this.value)">
            <option value="stage" {{ 'selected' if current_sort == 'stage' else '' }}>Sort: Stage</option>
            <option value="updated" {{ 'selected' if current_sort == 'updated' else '' }}>Sort: Updated</option>
            <option value="created" {{ 'selected' if current_sort == 'created' else '' }}>Sort: Created</option>
            <option value="number" {{ 'selected' if current_sort == 'number' else '' }}>Sort: Number</option>
        </select>
        <select class="header-select" onchange="updateFlowParams('filter', this.value)">
            <option value="all" {{ 'selected' if current_filter == 'all' else '' }}>Filter: All</option>
            <option value="review" {{ 'selected' if current_filter == 'review' else '' }}>Filter: Review</option>
            <option value="running" {{ 'selected' if current_filter == 'running' else '' }}>Filter: Running</option>
            <option value="open" {{ 'selected' if current_filter == 'open' else '' }}>Filter: Open</option>
        </select>
        <script>
            function updateFlowParams(param, value) {
                const url = new URL(window.location);
                if (value === 'stage' && param === 'sort') {
                    url.searchParams.delete('sort');
                } else if (value === 'all' && param === 'filter') {
                    url.searchParams.delete('filter');
                } else {
                    url.searchParams.set(param, value);
                }
                window.location.href = url.toString();
            }
        </script>
        {% endif %}
        <button class="header-btn btn-new" onclick="openNewIssueModal()">+ New</button>
        <div class="header-spacer"></div>
        <input type="search"
               id="search-input"
               name="search"
               class="search-input"
               placeholder="Search..."
               value="{{ search }}"
               hx-get="/{{ active_page }}"
               hx-trigger="input changed delay:300ms, search"
               hx-target="body"
               hx-swap="outerHTML"
               hx-push-url="true"
               hx-preserve="true"
               hx-include=".search-preserve">
        {% if request.query_params.get('view') %}
        <input type="hidden" name="view" value="{{ request.query_params.get('view') }}" class="search-preserve">
        {% endif %}
        {% if request.query_params.get('issue') %}
        <input type="hidden" name="issue" value="{{ request.query_params.get('issue') }}" class="search-preserve">
        {% endif %}
        <a href="/settings" class="header-icon-btn" title="Settings">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
        </a>
        <button class="header-icon-btn" onclick="toggleManagerPanel()" title="Toggle manager panel">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
        </button>
    </div>
</header>
<script>
    // Apply saved theme on load
    (function() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
    })();
</script>
