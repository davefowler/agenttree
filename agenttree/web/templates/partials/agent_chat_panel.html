<!-- Shared agent chat panel - used by both flow view and kanban modal -->
<div class="agent-chat-panel" id="agent-chat-panel-{{ issue.number }}">
    <div class="agent-chat-header">
        <h4>Agent Chat</h4>
    </div>
    <div class="agent-chat-content">
        {% if issue.tmux_active %}
        <div class="agent-status">
            <span class="status-indicator active"></span>
            Agent running
        </div>
        {% with chat_id=issue.number, get_url="/agent/" ~ issue.number ~ "/tmux", post_url="/agent/" ~ issue.number ~ "/send", placeholder="Send message to agent..." %}
            {% include "partials/tmux_chat.html" %}
        {% endwith %}
        {% else %}
        <div class="no-agent-message">
            <p>No agent assigned</p>
            <p>Click "Start Agent" to begin</p>
        </div>
        {% endif %}
    </div>
</div>
<script>
// Restart agent when Claude has exited
window.restartAgent = async function(issueNumber) {
    const warning = document.querySelector('.claude-exited-warning');
    if (warning) {
        warning.innerHTML = 'Restarting agent...';
    }

    try {
        const response = await fetch(`/api/issues/${issueNumber}/start`, {
            method: 'POST'
        });

        if (response.ok) {
            // Refresh the tmux output area to pick up the new session
            if (warning) {
                warning.innerHTML = 'Agent restarted! Waiting for Claude...';
            }
            // The HTMX polling will automatically update the output
        } else {
            const data = await response.json();
            if (warning) {
                warning.innerHTML = `Restart failed: ${data.error || 'Unknown error'}`;
            }
        }
    } catch (error) {
        if (warning) {
            warning.innerHTML = `Restart failed: ${error.message}`;
        }
    }
};

// Chat panel toggle with localStorage persistence
function toggleChatPanel(issueNumber) {
    const panel = document.getElementById('agent-chat-panel-' + issueNumber);
    if (panel) {
        panel.classList.toggle('collapsed');
        const isOpen = !panel.classList.contains('collapsed');
        localStorage.setItem('chatPanelOpen', isOpen ? '1' : '0');
    }
}

// Initialize chat panel state from localStorage
(function() {
    const chatOpen = localStorage.getItem('chatPanelOpen') !== '0';
    if (!chatOpen) {
        document.querySelectorAll('.agent-chat-panel').forEach(function(panel) {
            panel.classList.add('collapsed');
        });
    }
})();
</script>
