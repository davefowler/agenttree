<!-- Shared agent chat panel - used by both flow view and kanban modal -->
<div class="agent-chat-panel" id="agent-chat-panel-{{ issue.number }}">
    <div class="agent-chat-header">
        <h4>Agent Chat</h4>
    </div>
    <div class="agent-chat-content">
        {% if issue.assigned_agent %}
        <div class="agent-status">
            <span class="status-indicator active"></span>
            Agent {{ issue.assigned_agent }} assigned
        </div>
        <div class="tmux-output" id="tmux-output-{{ issue.number }}"
             hx-get="/agent/{{ issue.number }}/tmux"
             hx-trigger="load, every 2s"
             hx-swap="innerHTML"
             hx-preserve="true">
            Loading...
        </div>
        <div class="tmux-input-container">
            <form hx-post="/agent/{{ issue.number }}/send"
                  hx-trigger="submit"
                  hx-swap="none"
                  hx-on::after-request="this.reset()"
                  class="send-form">
                <input type="text" name="message" class="tmux-input"
                       placeholder="Send message to agent..."
                       autocomplete="off"
                       required>
                <button type="submit" class="send-button">
                    <span class="btn-text">Send</span>
                    <span class="btn-loading htmx-indicator">...</span>
                </button>
            </form>
        </div>
        {% else %}
        <div class="no-agent-message">
            <p>No agent assigned</p>
            <p>Click "Start Agent" to begin</p>
        </div>
        {% endif %}
    </div>
</div>
<script>
// Chat panel toggle with localStorage persistence
function toggleChatPanel(issueNumber) {
    const panel = document.getElementById('agent-chat-panel-' + issueNumber);
    if (panel) {
        panel.classList.toggle('collapsed');
        const isOpen = !panel.classList.contains('collapsed');
        localStorage.setItem('chatPanelOpen', isOpen ? '1' : '0');
    }
}

// Smart auto-scroll: only scroll to bottom if user was already at bottom
(function() {
    // Track which tmux outputs were at bottom before HTMX swap
    const wasAtBottom = new Map();

    // Before swap: check if scrolled to bottom (within 50px tolerance)
    document.body.addEventListener('htmx:beforeSwap', function(e) {
        const target = e.detail.target;
        if (target && target.classList.contains('tmux-output')) {
            const isAtBottom = target.scrollHeight - target.scrollTop - target.clientHeight < 50;
            wasAtBottom.set(target.id, isAtBottom);
        }
    });

    // After swap: scroll to bottom if user was at bottom
    document.body.addEventListener('htmx:afterSwap', function(e) {
        const target = e.detail.target;
        if (target && target.classList.contains('tmux-output')) {
            if (wasAtBottom.get(target.id)) {
                target.scrollTop = target.scrollHeight;
            }
            wasAtBottom.delete(target.id);
        }
    });

    // Initialize chat panel state from localStorage
    const chatOpen = localStorage.getItem('chatPanelOpen') !== '0';
    if (!chatOpen) {
        document.querySelectorAll('.agent-chat-panel').forEach(function(panel) {
            panel.classList.add('collapsed');
        });
    }
})();
</script>
