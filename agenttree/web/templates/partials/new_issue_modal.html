<!-- Shared new issue modal - included in kanban, flow, and mobile -->
<div id="new-issue-modal" class="modal">
    <div class="modal-content new-issue-modal-content">
        <button class="modal-close" onclick="closeNewIssueModal()">&times;</button>
        <div class="new-issue-form-container">
            <h2>Create New Issue</h2>
            <form id="new-issue-form" onsubmit="submitNewIssue(event)">
                <div class="form-group">
                    <label for="issue-description">Description</label>
                    <textarea id="issue-description" name="description" rows="12" autofocus
                              placeholder="Describe the problem and any ideas for solutions..."></textarea>
                </div>
                <div class="form-group">
                    <label for="issue-title">Title <span class="label-hint">(optional - auto-generated if blank)</span></label>
                    <input type="text" id="issue-title" name="title"
                           placeholder="Leave blank to auto-generate from description">
                </div>
                <div class="form-group">
                    <label for="issue-flow">Flow</label>
                    <select id="issue-flow" name="flow" class="form-select">
                        <option value="">Auto</option>
                        {% for flow_name in flows %}
                        <option value="{{ flow_name }}">{{ flow_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeNewIssueModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="create-issue-btn">Create Issue</button>
                </div>
                <div id="new-issue-error" class="form-error"></div>
            </form>
        </div>
    </div>
</div>

<script>
window.openNewIssueModal = function() {
    document.getElementById('new-issue-modal').classList.add('active');
    document.getElementById('issue-description').focus();
    // Add modal state to URL
    var url = new URL(window.location);
    url.searchParams.set('modal', 'new-issue');
    history.pushState({}, '', url);
};

window.closeNewIssueModal = function() {
    document.getElementById('new-issue-modal').classList.remove('active');
    document.getElementById('new-issue-form').reset();
    document.getElementById('new-issue-error').textContent = '';
    var btn = document.getElementById('create-issue-btn');
    btn.disabled = false;
    btn.textContent = 'Create Issue';
    // Remove modal state from URL
    var url = new URL(window.location);
    url.searchParams.delete('modal');
    history.replaceState({}, '', url);
};

window.submitNewIssue = async function(event) {
    event.preventDefault();
    var form = document.getElementById('new-issue-form');
    var errorDiv = document.getElementById('new-issue-error');
    var submitBtn = document.getElementById('create-issue-btn');
    var formData = new FormData(form);

    var description = (formData.get('description') || '').trim();
    if (!description) {
        errorDiv.textContent = 'Please provide a description';
        return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Creating...';
    errorDiv.textContent = '';

    try {
        var response = await fetch('/api/issues', {
            method: 'POST',
            body: formData
        });
        var data = await response.json();

        if (response.ok && data.ok) {
            closeNewIssueModal();
            // Redirect to the new issue on the current page
            var path = window.location.pathname;
            if (path.startsWith('/mobile')) {
                window.location.href = '/mobile?issue=' + data.issue_id + '&tab=detail';
            } else if (path.startsWith('/flow')) {
                window.location.href = '/flow?issue=' + data.issue_id;
            } else {
                window.location.href = '/kanban?issue=' + data.issue_id;
            }
        } else {
            errorDiv.textContent = data.detail || 'Failed to create issue';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Create Issue';
        }
    } catch (error) {
        errorDiv.textContent = 'Network error. Please try again.';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Create Issue';
    }
};

// Close on background click
(function() {
    var modal = document.getElementById('new-issue-modal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target.id === 'new-issue-modal') {
                closeNewIssueModal();
            }
        });
    }
})();

// Auto-open modal if URL has modal=new-issue
(function() {
    var url = new URL(window.location);
    if (url.searchParams.get('modal') === 'new-issue') {
        document.getElementById('new-issue-modal').classList.add('active');
        document.getElementById('issue-description').focus();
    }
})();
</script>
