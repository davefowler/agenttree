<!-- Shared new issue modal - included in kanban, flow, and mobile -->
<div id="new-issue-modal" class="modal">
    <div class="modal-content new-issue-modal-content">
        <button class="modal-close" onclick="closeNewIssueModal()">&times;</button>
        <div class="new-issue-form-container">
            <h2>Create New Issue</h2>
            <form id="new-issue-form" onsubmit="submitNewIssue(event)">
                <div class="form-group">
                    <label for="issue-description">Description</label>
                    <textarea id="issue-description" name="description" rows="12" autofocus
                              placeholder="Describe the problem and any ideas for solutions..."></textarea>
                </div>
                <div class="form-group">
                    <label for="issue-title">Title <span class="label-hint">(optional - auto-generated if blank)</span></label>
                    <input type="text" id="issue-title" name="title"
                           placeholder="Leave blank to auto-generate from description">
                </div>
                <div class="form-group">
                    <label>Attachments <span class="label-hint">(paste, drag-drop, or click to add)</span></label>
                    <input type="file" id="attachment-input" multiple accept="image/*,.txt,.log,.md,.json,.yaml,.yml" style="display: none;">
                    <div id="attachment-dropzone" class="attachment-dropzone">
                        <span class="dropzone-text">Drop files here or <a href="#" onclick="document.getElementById('attachment-input').click(); return false;">browse</a></span>
                    </div>
                    <div id="attachment-preview" class="attachment-preview"></div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeNewIssueModal()">Cancel</button>
                    <button type="submit" class="btn btn-create" id="create-issue-btn">Create Issue<span class="shortcut-hint" id="create-issue-shortcut"></span></button>
                </div>
                <div id="new-issue-error" class="form-error"></div>
            </form>
        </div>
    </div>
</div>

<script>
// Pending attachments array
var pendingAttachments = [];

// HTML escape helper to prevent XSS
function escapeHtml(str) {
    var div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

// Platform-aware shortcut hint
var isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
var shortcutText = isMac ? 'âŒ˜â†©' : 'Ctrl+â†©';

window.openNewIssueModal = function() {
    document.getElementById('new-issue-modal').classList.add('active');
    document.getElementById('issue-description').focus();
};

window.closeNewIssueModal = function() {
    document.getElementById('new-issue-modal').classList.remove('active');
    document.getElementById('new-issue-form').reset();
    document.getElementById('new-issue-error').textContent = '';
    pendingAttachments = [];
    updateAttachmentPreview();
    var btn = document.getElementById('create-issue-btn');
    btn.disabled = false;
    btn.innerHTML = 'Create Issue<span class="shortcut-hint" id="create-issue-shortcut">' + shortcutText + '</span>';
};

function addAttachment(file) {
    // Check file size (10MB limit)
    if (file.size > 10 * 1024 * 1024) {
        document.getElementById('new-issue-error').textContent = 'File too large (max 10MB): ' + file.name;
        return;
    }
    pendingAttachments.push(file);
    updateAttachmentPreview();
}

function removeAttachment(index) {
    pendingAttachments.splice(index, 1);
    updateAttachmentPreview();
}

function updateAttachmentPreview() {
    var preview = document.getElementById('attachment-preview');
    if (pendingAttachments.length === 0) {
        preview.innerHTML = '';
        return;
    }
    var html = '';
    for (var i = 0; i < pendingAttachments.length; i++) {
        var file = pendingAttachments[i];
        var icon = file.type.startsWith('image/') ? 'ðŸ–¼ï¸' : 'ðŸ“„';
        html += '<div class="attachment-item">' +
            '<span class="attachment-icon">' + icon + '</span>' +
            '<span class="attachment-name">' + escapeHtml(file.name) + '</span>' +
            '<button type="button" class="attachment-remove" onclick="removeAttachment(' + i + ')">&times;</button>' +
            '</div>';
    }
    preview.innerHTML = html;
}

window.submitNewIssue = async function(event) {
    event.preventDefault();
    var form = document.getElementById('new-issue-form');
    var errorDiv = document.getElementById('new-issue-error');
    var submitBtn = document.getElementById('create-issue-btn');
    var formData = new FormData(form);

    // Add pending attachments to form data
    for (var i = 0; i < pendingAttachments.length; i++) {
        formData.append('files', pendingAttachments[i]);
    }

    var description = (formData.get('description') || '').trim();
    if (!description) {
        errorDiv.textContent = 'Please provide a description';
        return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Creating...';
    errorDiv.textContent = '';

    try {
        var response = await fetch('/api/issues', {
            method: 'POST',
            body: formData
        });
        var data = await response.json();

        if (response.ok && data.ok) {
            closeNewIssueModal();
            // Redirect to the new issue on the current page
            var path = window.location.pathname;
            if (path.startsWith('/mobile')) {
                window.location.href = '/mobile?issue=' + data.issue_id + '&tab=detail';
            } else if (path.startsWith('/flow')) {
                window.location.href = '/flow?issue=' + data.issue_id;
            } else {
                window.location.href = '/kanban?issue=' + data.issue_id;
            }
        } else {
            errorDiv.textContent = data.detail || 'Failed to create issue';
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Create Issue<span class="shortcut-hint">' + shortcutText + '</span>';
        }
    } catch (error) {
        errorDiv.textContent = 'Network error. Please try again.';
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Create Issue<span class="shortcut-hint">' + shortcutText + '</span>';
    }
};

// Close on background click and setup keyboard shortcuts
(function() {
    var modal = document.getElementById('new-issue-modal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target.id === 'new-issue-modal') {
                closeNewIssueModal();
            }
        });
    }

    // Initialize shortcut hint
    var shortcutHint = document.getElementById('create-issue-shortcut');
    if (shortcutHint) {
        shortcutHint.textContent = shortcutText;
    }

    // Cmd/Ctrl+Enter to submit from textarea
    var textarea = document.getElementById('issue-description');
    if (textarea) {
        textarea.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
                e.preventDefault();
                document.getElementById('new-issue-form').requestSubmit();
            }
        });
    }
})();

// Attachment event handlers
(function() {
    var dropzone = document.getElementById('attachment-dropzone');
    var fileInput = document.getElementById('attachment-input');
    var textarea = document.getElementById('issue-description');

    if (dropzone && fileInput) {
        // File input change
        fileInput.addEventListener('change', function(e) {
            var files = e.target.files;
            for (var i = 0; i < files.length; i++) {
                addAttachment(files[i]);
            }
            fileInput.value = '';
        });

        // Drag and drop
        dropzone.addEventListener('dragover', function(e) {
            e.preventDefault();
            dropzone.classList.add('dragover');
        });

        dropzone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            dropzone.classList.remove('dragover');
        });

        dropzone.addEventListener('drop', function(e) {
            e.preventDefault();
            dropzone.classList.remove('dragover');
            var files = e.dataTransfer.files;
            for (var i = 0; i < files.length; i++) {
                addAttachment(files[i]);
            }
        });
    }

    // Paste handler on textarea
    if (textarea) {
        textarea.addEventListener('paste', function(e) {
            var items = e.clipboardData.items;
            for (var i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    var file = items[i].getAsFile();
                    if (file) {
                        addAttachment(file);
                    }
                }
            }
        });
    }
})();
</script>
