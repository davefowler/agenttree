<!-- Unified issue detail content - used by both kanban modal and flow panel -->
<div class="issue-detail-wrapper" data-issue-id="{{ issue.number }}" data-agent-num="{{ issue.assigned_agent or '' }}">
    <div class="issue-detail-main">
        <!-- Issue header -->
        <div class="detail-header">
            <div class="detail-title-row">
                <div class="detail-title">
                    #{{ issue.number }}: {{ issue.title }}
                </div>
                <div class="detail-title-actions">
                    <div class="agent-light-large {% if issue.tmux_active %}on{% elif issue.assigned_agent %}stalled{% else %}off{% endif %}"
                         onclick="toggleAgentFromDetail('{{ issue.number }}', this)"
                         title="{% if issue.tmux_active %}Agent running{% elif issue.assigned_agent %}Agent stalled - click to restart{% else %}Click to start agent{% endif %}">
                    </div>
                    <button class="chat-toggle-icon"
                            onclick="toggleChatPanel('{{ issue.number }}')"
                            title="Toggle agent chat">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="detail-meta-row">
                <div class="detail-meta">
                    <span>Stage: {{ issue.stage.replace('_', ' ').title() if issue.stage is string else issue.stage.value.replace('_', ' ').title() }}</span>
                    {% if issue.assigned_agent %}
                    <span>Agent: {{ issue.assigned_agent }}</span>
                    {% endif %}
                    {% if issue.pr_url %}
                    <span><a href="{{ issue.pr_url }}" target="_blank">PR #{{ issue.pr_number }}</a></span>
                    {% endif %}
                </div>
                <div class="detail-actions" id="detail-actions-{{ issue.number }}">
                    {% if issue.assigned_agent and commits_behind is defined and commits_behind > 0 %}
                    <button class="btn btn-rebase"
                            onclick="rebaseIssue('{{ issue.number }}', this)">
                        Rebase ({{ commits_behind }} behind)
                    </button>
                    {% endif %}
                    {% if issue.stage != 'backlog' %}
                    <button class="btn btn-backlog"
                            onclick="backlogIssue('{{ issue.number }}', this)">
                        Backlog
                    </button>
                    {% endif %}
                    {% if issue.is_review %}
                    <button class="btn btn-approve"
                            onclick="approveIssue('{{ issue.number }}', this)">
                        Approve
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- File tabs -->
        <div class="file-tabs-container">
            <div class="file-tabs" id="file-tabs-{{ issue.number }}">
                {% for file in files %}
                <button class="file-tab{% if loop.last %} active{% endif %}"
                        onclick="selectFileTab(event, '{{ issue.number }}', '{{ file.name }}')"
                        data-filename="{{ file.name }}">
                    {{ file.display_name }}
                </button>
                {% else %}
                <span class="no-files">No files found</span>
                {% endfor %}
            </div>
        </div>

        <!-- File content - all files loaded upfront, CSS toggles visibility -->
        <div class="issue-content" id="file-content-{{ issue.number }}">
            {% for file in files %}
            <div class="file-content-item"
                 data-filename="{{ file.name }}"
                 style="display: {% if loop.last %}block{% else %}none{% endif %};">
                {% if file.content %}
                <div class="markdown-rendered" id="markdown-{{ issue.number }}-{{ loop.index }}"></div>
                <script type="text/template" id="source-{{ issue.number }}-{{ loop.index }}">{{ file.content }}</script>
                <script>
                    (function() {
                        const source = document.getElementById('source-{{ issue.number }}-{{ loop.index }}').textContent;
                        const display = document.getElementById('markdown-{{ issue.number }}-{{ loop.index }}');
                        if (typeof marked !== 'undefined') {
                            display.innerHTML = marked.parse(source);
                        } else {
                            display.innerHTML = '<pre class="markdown-raw">' + source + '</pre>';
                        }
                    })();
                </script>
                {% else %}
                <div class="empty-state">
                    <p>No content available</p>
                </div>
                {% endif %}
            </div>
            {% else %}
            <div class="empty-state">
                <p>No files found for this issue</p>
            </div>
            {% endfor %}
        </div>

        <!-- Timestamps -->
        <div class="detail-timestamps">
            <small>Created: {{ issue.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
            <small>Updated: {{ issue.updated_at.strftime('%Y-%m-%d %H:%M') }}</small>
        </div>
    </div>

    <!-- Agent Chat Panel -->
    {% include "partials/agent_chat_panel.html" %}
</div>

<script>
// Action handlers for this issue detail - AJAX + reload pattern
async function approveIssue(issueNumber, btn) {
    btn.disabled = true;
    btn.textContent = 'Approving...';

    try {
        const response = await fetch(`/api/issues/${issueNumber}/approve`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });

        if (response.ok) {
            btn.textContent = 'Approved!';
            setTimeout(() => location.reload(), 500);
        } else {
            const data = await response.json();
            alert(`Cannot approve: ${data.detail || 'Unknown error'}`);
            btn.disabled = false;
            btn.textContent = 'Approve';
        }
    } catch (error) {
        console.error('Error approving:', error);
        btn.disabled = false;
        btn.textContent = 'Approve';
    }
}

async function rebaseIssue(issueNumber, btn) {
    btn.disabled = true;
    btn.textContent = 'Rebasing...';

    try {
        const response = await fetch(`/api/issues/${issueNumber}/rebase`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });

        if (response.ok) {
            btn.textContent = 'Rebased!';
            setTimeout(() => location.reload(), 500);
        } else {
            const data = await response.json();
            alert(`Cannot rebase: ${data.detail || 'Unknown error'}`);
            btn.disabled = false;
            btn.textContent = 'Rebase';
        }
    } catch (error) {
        console.error('Error rebasing:', error);
        btn.disabled = false;
        btn.textContent = 'Rebase';
    }
}

async function backlogIssue(issueNumber, btn) {
    if (!confirm('Move this issue to backlog? This will stop any running agent.')) {
        return;
    }

    btn.disabled = true;
    btn.textContent = 'Moving...';

    try {
        const response = await fetch(`/api/issues/${issueNumber}/move`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({stage: 'backlog'})
        });

        if (response.ok) {
            btn.textContent = 'Moved!';
            setTimeout(() => location.reload(), 500);
        } else {
            const data = await response.json();
            alert(`Cannot move to backlog: ${data.detail || 'Unknown error'}`);
            btn.disabled = false;
            btn.textContent = 'Backlog';
        }
    } catch (error) {
        console.error('Error moving to backlog:', error);
        btn.disabled = false;
        btn.textContent = 'Backlog';
    }
}
</script>
