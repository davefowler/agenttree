<!-- Unified issue detail content - used by both kanban modal and flow panel -->
<div class="issue-detail-wrapper" data-issue-id="{{ issue.number }}" data-agent-num="{{ issue.assigned_agent or '' }}">
    <div class="issue-detail-main">
        <!-- Issue header -->
        <div class="detail-header">
            <div class="detail-title-row">
                <div class="detail-title">
                    #{{ issue.number }}: {{ issue.title }}
                </div>
                <div class="detail-title-actions">
                    <div class="agent-light-large {% if issue.tmux_active %}on{% elif issue.assigned_agent %}stalled{% else %}off{% endif %}"
                         onclick="toggleAgentFromDetail('{{ issue.number }}', this)"
                         title="{% if issue.tmux_active %}Agent running{% elif issue.assigned_agent %}Agent stalled - click to restart{% else %}Click to start agent{% endif %}">
                    </div>
                    <button class="chat-toggle-icon" onclick="toggleAgentChat('{{ issue.number }}')" title="Toggle agent chat">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="detail-meta-row">
                <div class="detail-meta">
                    <span>Stage: {{ issue.stage.value.replace('_', ' ').title() }}</span>
                    {% if issue.assigned_agent %}
                    <span>Agent: {{ issue.assigned_agent }}</span>
                    {% endif %}
                    {% if issue.pr_url %}
                    <span><a href="{{ issue.pr_url }}" target="_blank">PR #{{ issue.pr_number }}</a></span>
                    {% endif %}
                </div>
                {% if issue.is_review %}
                <button class="btn btn-approve"
                        hx-post="/api/issues/{{ issue.number }}/approve"
                        hx-target="#approve-status-{{ issue.number }}"
                        hx-swap="innerHTML">
                    Approve
                </button>
                <span id="approve-status-{{ issue.number }}"></span>
                {% endif %}
            </div>
        </div>

        <!-- File tabs -->
        <div class="file-tabs-container">
            <div class="file-tabs" id="file-tabs-{{ issue.number }}">
                {% for file in files %}
                <button class="file-tab{% if loop.last %} active{% endif %}"
                        onclick="selectFileTab(event, '{{ issue.number }}', '{{ file.name }}')">
                    {{ file.display_name }}
                </button>
                {% else %}
                <span class="no-files">No files found</span>
                {% endfor %}
            </div>
        </div>

        <!-- File content -->
        <div class="issue-content file-content" id="file-content-{{ issue.number }}">
            {% if issue.body %}
            <div class="markdown-rendered"></div>
            <script type="text/template">{{ issue.body }}</script>
            <script>
                (function() {
                    const script = document.currentScript;
                    const source = script.previousElementSibling.textContent;
                    const display = script.previousElementSibling.previousElementSibling;
                    if (typeof marked !== 'undefined') {
                        display.innerHTML = marked.parse(source);
                    } else {
                        display.innerHTML = '<pre class="markdown-raw">' + source + '</pre>';
                    }
                })();
            </script>
            {% else %}
            <div class="empty-state">
                <p>No content available</p>
            </div>
            {% endif %}
        </div>

        <!-- Timestamps -->
        <div class="detail-timestamps">
            <small>Created: {{ issue.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
            <small>Updated: {{ issue.updated_at.strftime('%Y-%m-%d %H:%M') }}</small>
        </div>
    </div>

    <!-- Agent Chat Panel -->
    {% include "partials/agent_chat_panel.html" %}
</div>
