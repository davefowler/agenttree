<!-- Unified issue detail content - used by both kanban modal and flow panel -->
<div class="issue-detail-wrapper" data-issue-id="{{ issue.number }}">
    <div class="issue-detail-main">
        <!-- Issue header -->
        <div class="detail-header">
            <div class="detail-title-row">
                <div class="detail-title">
                    #{{ issue.number }}: {{ issue.title }}
                </div>
                <div class="detail-title-actions">
                    <div class="agent-light-large {% if issue.processing %}processing{% elif issue.tmux_active %}on{% else %}off{% endif %}"
                         onclick="toggleAgentFromDetail('{{ issue.number }}', this)"
                         title="{% if issue.processing %}Processing hooks...{% elif issue.tmux_active %}Agent running{% else %}Click to start agent{% endif %}">
                    </div>
                    <button class="chat-toggle-icon"
                            onclick="toggleChatPanel('{{ issue.number }}')"
                            title="Toggle agent chat">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="detail-meta-row">
                <div class="detail-meta">
                    <span>Stage: {{ issue.stage.replace('_', ' ').title() if issue.stage is string else issue.stage.value.replace('_', ' ').title() }}</span>
                    <span>Priority:
                        <select class="priority-select" onchange="updatePriority('{{ issue.number }}', this.value, this)">
                            <option value="low" {% if issue.priority == 'low' %}selected{% endif %}>Low</option>
                            <option value="medium" {% if issue.priority == 'medium' %}selected{% endif %}>Medium</option>
                            <option value="high" {% if issue.priority == 'high' %}selected{% endif %}>High</option>
                            <option value="critical" {% if issue.priority == 'critical' %}selected{% endif %}>Critical</option>
                        </select>
                    </span>
                    {% if issue.pr_url %}
                    <span><a href="{{ issue.pr_url }}" target="_blank">PR #{{ issue.pr_number }}</a></span>
                    {% endif %}
                    {% if issue.port and issue.tmux_active %}
                    <span><a href="http://localhost:{{ issue.port }}" target="_blank">Dev Server :{{ issue.port }}</a></span>
                    {% endif %}
                    {% if issue.dependencies %}
                    <span class="dependency-info">Blocked by:
                        {% for dep in issue.dependencies %}
                        <span class="dep-pill" data-issue="{{ issue.number }}" data-dep="{{ dep }}">
                            <a href="?issue={{ dep }}">#{{ dep }}</a>
                            <button class="dep-remove" onclick="removeDependency('{{ issue.number }}', '{{ dep }}', this.parentElement)" title="Remove dependency">x</button>
                        </span>
                        {% endfor %}
                    </span>
                    {% endif %}
                    {% if issue.dependents %}
                    <span class="dependent-info">Blocks: {% for dep in issue.dependents %}<a href="?issue={{ dep }}">#{{ dep }}</a>{% if not loop.last %}, {% endif %}{% endfor %}</span>
                    {% endif %}
                </div>
                <div class="detail-actions" id="detail-actions-{{ issue.number }}">
                    {% set stage_value = issue.stage if issue.stage is string else issue.stage.value %}
                    {% if issue.tmux_active and commits_behind is defined and commits_behind > 0 %}
                    <button class="btn btn-rebase"
                            onclick="rebaseIssue('{{ issue.number }}', this)">
                        Rebase ({{ commits_behind }} behind)
                    </button>
                    {% endif %}
                    {% if stage_value not in ['not_doing', 'accepted'] %}
                    <button class="btn btn-archive"
                            onclick="archiveIssue('{{ issue.number }}', this)">
                        Archive
                    </button>
                    {% endif %}
                    {% if stage_value == 'backlog' %}
                    <button class="btn btn-start"
                            onclick="startIssue('{{ issue.number }}', this)">
                        Start
                    </button>
                    {% elif stage_value not in ['not_doing', 'accepted'] %}
                    <button class="btn btn-backlog"
                            onclick="backlogIssue('{{ issue.number }}', this)">
                        Backlog
                    </button>
                    {% endif %}
                    {% if issue.is_review %}
                    <button class="btn btn-approve"
                            onclick="approveIssue('{{ issue.number }}', this)"
                            {% if issue.processing %}disabled{% endif %}>
                        {% if issue.processing %}Processing...{% else %}Approve{% endif %}
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- File tabs (desktop) -->
        {# Determine which file should be active: use default_doc if exists, else last file #}
        {% set active_file = namespace(name=None) %}
        {% if default_doc %}
            {% for file in files %}
                {% if file.name == default_doc %}
                    {% set active_file.name = default_doc %}
                {% endif %}
            {% endfor %}
        {% endif %}
        {% if not active_file.name and files %}
            {% set active_file.name = files[-1].name %}
        {% endif %}
        <div class="file-tabs-container">
            <div class="file-tabs" id="file-tabs-{{ issue.number }}">
                {% for file in files %}
                <button class="file-tab{% if file.name == active_file.name and not issue.has_worktree %} active{% endif %}"
                        onclick="selectFileTab(event, '{{ issue.number }}', '{{ file.name }}')"
                        data-filename="{{ file.name }}">
                    {{ file.display_name }}
                </button>
                {% else %}
                <span class="no-files">No files found</span>
                {% endfor %}
                {% if issue.has_worktree %}
                <button class="file-tab{% if files|length == 0 %} active{% endif %}"
                        onclick="selectFileTab(event, '{{ issue.number }}', 'changes'); loadDiff('{{ issue.number }}')"
                        data-filename="changes">
                    Changes
                </button>
                {% endif %}
            </div>
            <!-- Mobile file selector dropdown -->
            <select class="mobile-file-select" onchange="selectFileFromDropdown(this, '{{ issue.number }}')">
                {% for file in files %}
                <option value="{{ file.name }}"{% if file.name == active_file.name and not issue.has_worktree %} selected{% endif %}>{{ file.display_name }}</option>
                {% endfor %}
                {% if issue.has_worktree %}
                <option value="changes"{% if files|length == 0 %} selected{% endif %}>Changes</option>
                {% endif %}
            </select>
        </div>

        <!-- File content - all files loaded upfront, CSS toggles visibility -->
        <div class="issue-content" id="file-content-{{ issue.number }}">
            {% for file in files %}
            <div class="file-content-item"
                 data-filename="{{ file.name }}"
                 style="display: {% if file.name == active_file.name %}block{% else %}none{% endif %};">
                {% if file.content %}
                {% if file.name.endswith('.yaml') or file.name.endswith('.yml') %}
                <pre class="yaml-content">{{ file.content }}</pre>
                {% else %}
                <div class="markdown-rendered" id="markdown-{{ issue.number }}-{{ loop.index }}"></div>
                <script type="text/template" id="source-{{ issue.number }}-{{ loop.index }}">{{ file.content }}</script>
                <script>
                    (function() {
                        const source = document.getElementById('source-{{ issue.number }}-{{ loop.index }}').textContent;
                        const display = document.getElementById('markdown-{{ issue.number }}-{{ loop.index }}');
                        if (typeof marked !== 'undefined') {
                            display.innerHTML = marked.parse(source);
                        } else {
                            display.innerHTML = '<pre class="markdown-raw">' + source + '</pre>';
                        }
                    })();
                </script>
                {% endif %}
                {% else %}
                <div class="empty-state">
                    <p>No content available</p>
                </div>
                {% endif %}
            </div>
            {% else %}
            <div class="empty-state">
                <p>No files found for this issue</p>
            </div>
            {% endfor %}

            {% if issue.has_worktree %}
            <!-- Diff content area -->
            <div class="file-content-item"
                 data-filename="changes"
                 style="display: none;">
                <div class="diff-loading" id="diff-loading-{{ issue.number }}" style="display: none;">
                    <div class="spinner"></div>
                    <span>Loading diff...</span>
                </div>
                <div class="diff-error" id="diff-error-{{ issue.number }}" style="display: none;"></div>
                <div class="diff-content" id="diff-content-{{ issue.number }}"></div>
            </div>
            {% endif %}
        </div>

        <!-- Timestamps -->
        <div class="detail-timestamps">
            <small>Created: {{ issue.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
            <small>Updated: {{ issue.updated_at.strftime('%Y-%m-%d %H:%M') }}</small>
        </div>
    </div>

    <!-- Agent Chat Panel -->
    {% include "partials/agent_chat_panel.html" %}
</div>

<script>
// Helper to refresh the page after a state-changing action
// Always reload to get fresh data after approve, rebase, move, etc.
function afterAction() {
    location.reload();
}

// Update issue priority
async function updatePriority(issueNumber, priority, selectEl) {
    const originalValue = selectEl.getAttribute('data-original') || selectEl.value;
    selectEl.setAttribute('data-original', originalValue);
    selectEl.disabled = true;

    try {
        const response = await fetch(`/api/issues/${issueNumber}/priority`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({priority: priority})
        });

        if (response.ok) {
            selectEl.disabled = false;
            selectEl.setAttribute('data-original', priority);
            // Reload to update the card badge
            setTimeout(afterAction, 300);
        } else {
            const data = await response.json();
            alert(`Cannot update priority: ${data.detail || 'Unknown error'}`);
            selectEl.value = originalValue;
            selectEl.disabled = false;
        }
    } catch (error) {
        console.error('Error updating priority:', error);
        selectEl.value = originalValue;
        selectEl.disabled = false;
    }
}

// Action handlers for this issue detail
async function approveIssue(issueNumber, btn) {
    // Immediately show processing state
    btn.disabled = true;
    btn.textContent = 'Processing...';

    // Find and update agent light to show processing
    const wrapper = btn.closest('.issue-detail-wrapper');
    const agentLight = wrapper ? wrapper.querySelector('.agent-light-large') : null;
    if (agentLight) {
        agentLight.classList.remove('on', 'off');
        agentLight.classList.add('processing');
        agentLight.title = 'Processing hooks...';
    }

    try {
        // Wait for the approve request to complete (hooks run synchronously)
        const response = await fetch(`/api/issues/${issueNumber}/approve`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });

        if (response.ok) {
            btn.textContent = 'Approved!';
            // Move to next issue or reload
            if (typeof goToNextIssue === 'function') {
                goToNextIssue();
            } else {
                setTimeout(afterAction, 500);
            }
        } else {
            const data = await response.json();
            alert(`Cannot approve: ${data.detail || 'Unknown error'}`);
            // Re-enable button and restore state
            btn.disabled = false;
            btn.textContent = 'Approve';
            if (agentLight) {
                agentLight.classList.remove('processing');
                agentLight.classList.add('off');
                agentLight.title = 'Click to start agent';
            }
        }
    } catch (error) {
        console.error('Error approving:', error);
        alert('Error approving issue');
        // Re-enable button and restore state
        btn.disabled = false;
        btn.textContent = 'Approve';
        if (agentLight) {
            agentLight.classList.remove('processing');
            agentLight.classList.add('off');
            agentLight.title = 'Click to start agent';
        }
    }
}

async function rebaseIssue(issueNumber, btn) {
    btn.disabled = true;
    btn.textContent = 'Rebasing...';

    try {
        const response = await fetch(`/api/issues/${issueNumber}/rebase`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });

        if (response.ok) {
            btn.textContent = 'Rebased!';
            setTimeout(afterAction, 500);
        } else {
            const data = await response.json();
            alert(`Cannot rebase: ${data.detail || 'Unknown error'}`);
            btn.disabled = false;
            btn.textContent = 'Rebase';
        }
    } catch (error) {
        console.error('Error rebasing:', error);
        btn.disabled = false;
        btn.textContent = 'Rebase';
    }
}

async function backlogIssue(issueNumber, btn) {
    if (!confirm('Move this issue to backlog? This will stop any running agent.')) {
        return;
    }

    btn.disabled = true;
    btn.textContent = 'Moving...';

    try {
        const response = await fetch(`/api/issues/${issueNumber}/move`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({stage: 'backlog'})
        });

        if (response.ok) {
            btn.textContent = 'Moved!';
            setTimeout(afterAction, 500);
        } else {
            const data = await response.json();
            alert(`Cannot move to backlog: ${data.detail || 'Unknown error'}`);
            btn.disabled = false;
            btn.textContent = 'Backlog';
        }
    } catch (error) {
        console.error('Error moving to backlog:', error);
        btn.disabled = false;
        btn.textContent = 'Backlog';
    }
}

async function startIssue(issueNumber, btn) {
    btn.disabled = true;
    btn.textContent = 'Starting...';

    try {
        const response = await fetch(`/api/issues/${issueNumber}/start`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });

        if (response.ok) {
            btn.textContent = 'Started!';
            setTimeout(afterAction, 1000);
        } else {
            const data = await response.json();
            alert(`Cannot start: ${data.detail || 'Unknown error'}`);
            btn.disabled = false;
            btn.textContent = 'Start';
        }
    } catch (error) {
        console.error('Error starting issue:', error);
        btn.disabled = false;
        btn.textContent = 'Start';
    }
}

async function archiveIssue(issueNumber, btn) {
    if (!confirm('Archive this issue? It will be moved to "Not Doing".')) {
        return;
    }

    btn.disabled = true;
    btn.textContent = 'Archiving...';

    try {
        const response = await fetch(`/api/issues/${issueNumber}/move`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({stage: 'not_doing'})
        });

        if (response.ok) {
            btn.textContent = 'Archived!';
            setTimeout(afterAction, 500);
        } else {
            const data = await response.json();
            alert(`Cannot archive: ${data.detail || 'Unknown error'}`);
            btn.disabled = false;
            btn.textContent = 'Archive';
        }
    } catch (error) {
        console.error('Error archiving issue:', error);
        btn.disabled = false;
        btn.textContent = 'Archive';
    }
}

// Remove a dependency from an issue
async function removeDependency(issueNumber, depId, pillElement) {
    try {
        const response = await fetch(`/api/issues/${issueNumber}/dependencies/${depId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            // Remove the pill from the DOM
            pillElement.remove();
            // If no more dependencies, remove the whole "Blocked by:" span
            const depInfo = document.querySelector('.dependency-info');
            if (depInfo && depInfo.querySelectorAll('.dep-pill').length === 0) {
                depInfo.remove();
            }
        } else {
            const data = await response.json();
            alert(`Cannot remove dependency: ${data.detail || 'Unknown error'}`);
        }
    } catch (error) {
        console.error('Error removing dependency:', error);
        alert('Error removing dependency');
    }
}

// Track which diffs have been loaded to avoid re-fetching
const loadedDiffs = new Set();

async function loadDiff(issueNumber) {
    // Skip if already loaded
    if (loadedDiffs.has(issueNumber)) {
        return;
    }

    const loadingEl = document.getElementById(`diff-loading-${issueNumber}`);
    const errorEl = document.getElementById(`diff-error-${issueNumber}`);
    const contentEl = document.getElementById(`diff-content-${issueNumber}`);

    if (!loadingEl || !contentEl) return;

    // Show loading state
    loadingEl.style.display = 'flex';
    errorEl.style.display = 'none';
    contentEl.innerHTML = '';

    try {
        const response = await fetch(`/api/issues/${issueNumber}/diff`);
        const data = await response.json();

        loadingEl.style.display = 'none';

        if (data.error) {
            errorEl.textContent = data.error;
            errorEl.style.display = 'block';
            return;
        }

        if (!data.has_changes) {
            contentEl.innerHTML = '<div class="diff-empty">No differences from main</div>';
            loadedDiffs.add(issueNumber);
            return;
        }

        // Show truncation warning if applicable
        if (data.truncated) {
            errorEl.textContent = 'Diff truncated due to size. View full diff in PR.';
            errorEl.className = 'diff-warning';
            errorEl.style.display = 'block';
        }

        // Render diff with diff2html
        if (typeof Diff2HtmlUI !== 'undefined') {
            const diff2htmlUi = new Diff2HtmlUI(contentEl, data.diff, {
                drawFileList: true,
                matching: 'lines',
                outputFormat: 'line-by-line',
                fileContentToggle: true
            });
            diff2htmlUi.draw();
            diff2htmlUi.highlightCode();
        } else {
            // Fallback: show raw diff
            contentEl.innerHTML = '<pre class="diff-raw">' + data.diff.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</pre>';
        }

        loadedDiffs.add(issueNumber);
    } catch (error) {
        loadingEl.style.display = 'none';
        errorEl.textContent = 'Failed to load diff: ' + error.message;
        errorEl.style.display = 'block';
        console.error('Error loading diff:', error);
    }
}
</script>
