name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for diff analysis

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          allowed_bots: "cursor,dependabot[bot],renovate[bot]"
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Review this pull request for the agenttree project.

            ## PRIORITY 0: Scope Check (CHECK THIS FIRST!)

            Run `gh pr diff ${{ github.event.pull_request.number }} --stat` and check:

            1. **Unrelated deletions** - Are files being deleted that aren't mentioned in the PR title/description?
               - Deleting test files, modules, or features unrelated to the stated goal is CRITICAL
               - Example: PR titled "Add color coding" should NOT delete rollback.py

            2. **Proportional changes** - Is the diff size reasonable for the stated goal?
               - A "small feature" PR with 1000+ lines changed is suspicious
               - A "bug fix" PR with 500+ deletions is suspicious

            3. **Scope creep** - Are there changes outside the PR's stated purpose?
               - Unrelated refactoring bundled with a feature
               - "Drive-by" fixes that should be separate PRs

            If ANY scope issues are found, mark as CRITICAL and recommend splitting the PR.

            ## PRIORITY 1: Anti-Slop â€” THESE ARE CRITICAL (see CLAUDE.md)

            Every item below is a CRITICAL issue that MUST block merge. Do NOT downgrade these to suggestions.

            - Dead code - new modules/classes/functions added but not actually used. This includes unused imports, unreferenced helper functions, and aliases that nothing calls. Dead code is ALWAYS critical.
            - Half-finished refactors - new code alongside old code that should be deleted
            - Repetitive functions that should be ONE parameterized function
            - Cowardly code - try/except around our own imports, defensive checks for guaranteed fields
            - Backwards compat cruft - aliases, duplicate fields, "Deprecated" comments on actively-used code (we are pre-launch, no BC needed)

            If you find ANY Anti-Slop violation, you MUST use verdict ðŸ”„ REQUEST CHANGES and CRITICAL_ISSUES_FOUND: YES.

            ## PRIORITY 2: Standard Review

            - **Critical Issues** - Security vulnerabilities, data loss risks, breaking changes
            - **Bugs** - Logic errors, edge cases, null/undefined handling
            - **Code Quality** - Following existing patterns, type safety, test coverage

            This is a Python project using:
            - Python 3.12+ with type hints
            - pytest for testing
            - mypy for type checking
            - Click for CLI

            Reference CLAUDE.md in the repo for project conventions.

            Format your review with clear sections:
            - Start with **Scope Check** results (diff stats, any concerns)
            - List any CRITICAL issues (these block merge)
            - Then list other suggestions
            - End with a clear **Recommendation** section

            For the Recommendation section, use one of these verdicts:
            - **âœ… APPROVE** - No critical issues, code is ready to merge
            - **ðŸ”„ REQUEST CHANGES** - Critical issues must be fixed before merge
            - **ðŸ’¬ COMMENT** - Minor suggestions only, author can merge at their discretion

            Use `gh pr comment` with your Bash tool to leave your review as a comment on the PR.

            If you find CRITICAL issues, include the text "CRITICAL_ISSUES_FOUND: YES" at the end.
            If no critical issues, include "CRITICAL_ISSUES_FOUND: NO" at the end.

          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'

      - name: Check for Critical Issues
        if: always()
        run: |
          # Check the LATEST comment for critical issues (not all comments)
          LATEST_COMMENT=$(gh pr view ${{ github.event.pull_request.number }} \
            --json comments --jq '.comments[-1].body' 2>/dev/null || echo "")

          if echo "$LATEST_COMMENT" | grep -q "CRITICAL_ISSUES_FOUND: YES"; then
            echo "::error::Claude found critical issues in this PR"
            echo "Please address the critical issues before merging."
            exit 1
          fi

          echo "No critical issues detected by Claude review"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
